<!DOCTYPE html>
<html>

<head>
  <title>Upload File</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>

<body>
  <h2 class="text-center mt-5 mb-2 p-2">Upload Credit Card Statement</h2>
  <form method="POST" enctype="multipart/form-data" class="container mt-5" style="max-width: 600px;" id="uploadForm">
    <div class="mb-3">
      {{ form.hidden_tag() }}
      {{ form.file.label(class="form-label") }}
      {{ form.file(class="form-control form-control-lg") }} <br><br>
      {{ form.submit(class="btn btn-outline-success") }}
    </div>
  </form>
  {% with messages = get_flashed_messages() %}
  {% if messages %}
  <ul>
    {% for msg in messages %}
    <li>{{ msg }}</li>
    {% endfor %}
  </ul>
  {% endif %}
  {% endwith %}


  <!-- <div id="charts" class="container mt-5" style="display:none;">
    <h3 class="text-center mb-4">Expense Analysis</h3>
    <div class="row">
      <div class="col-md-6 mb-4">
        <canvas id="dailyTrendChart"></canvas>
      </div>
      <div class="col-md-6 mb-4">
        <canvas id="categoryChart"></canvas>
      </div>
      <div class="col-md-6 mb-4">
        <canvas id="debitCreditChart"></canvas>
      </div>
    </div>
  </div> -->

  <div class="container charts-container" id="charts" style="display:none;">
    <div class="container mt-5 chart-card" id="categoryChartContainer">
      <h3>Spending by Category</h3>
      <canvas id="categoryChart"></canvas>
    </div>

    <div class="container mt-5 chart-card" id="dailyChartContainer">
      <h3>Daily Spending Trend</h3>
      <canvas id="dailyChart"></canvas>
    </div>
    <div class="container mt-5 chart-card" id="dailyChartContainer">
      <h3>Spending by Sub Category</h3>
      <canvas id="subcategoryChart"></canvas>
    </div>
    <div class="container mt-5 chart-card" id="dailyChartContainer">
      <h3>Spending by Sub Category</h3>
      <canvas id="subcategoryPieChart"></canvas>
    </div>
  </div>

  <div class="loader container mt-5 text-center" id="loader"></div>


  <style>
    .charts-container {
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      padding: 20px;
    }

    .chart-card {
      flex: 1 1 500px;
      max-width: 700px;
      border: 1px solid black;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .chart-card h3 {
      margin-bottom: 20px;
      font-family: "Segoe UI", sans-serif;
      font-weight: 600;
      color: #333;
    }

    canvas {
      width: 100% !important;
      height: 400px !important;
    }

    /* HTML: <div class="loader"></div> */
    .loader {
      --c:no-repeat linear-gradient(rgba(0, 0, 0, 0.67) 0 0);
      background: 
        var(--c),var(--c),var(--c),
        var(--c),var(--c),var(--c),
        var(--c),var(--c),var(--c);
      background-size: 16px 16px;
      display: none;
      animation: 
        l32-1 1s infinite,
        l32-2 1s infinite;
    }
    @keyframes l32-1 {
      0%,100% {width:45px;height: 45px}
      35%,65% {width:65px;height: 65px}
    }
    @keyframes l32-2 {
      0%,40%  {background-position: 0 0,0 50%, 0 100%,50% 100%,100% 100%,100% 50%,100% 0,50% 0,  50% 50% }
      60%,100%{background-position: 0 50%, 0 100%,50% 100%,100% 100%,100% 50%,100% 0,50% 0,0 0,  50% 50% }
    }

  </style>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Upload form handler
    document.getElementById("uploadForm").addEventListener("submit", async function (e) {
      const loader = document.getElementById("loader");
      loader.style.display = "block";
      e.preventDefault();
      const formData = new FormData(this);

      const res = await fetch("{{ url_for('upload') }}", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      console.log("Upload response:", data);

      if (data.status === "success") {
        renderCategoryChart(data.transactions);
        renderDailyChart(data.transactions);
        renderSubcategoryChart(data.transactions);
      }
      loader.style.display = "none";
    });

    // Render spending by category (Pie)
    function renderCategoryChart(transactions) {
      const ctx = document.getElementById("categoryChart").getContext("2d");
      charts = document.getElementById("charts");
      charts.style.display = "flex";

      // Aggregate totals by transaction_type
      const totals = transactions.reduce((acc, tx) => {
        acc[tx.transaction_type] = (acc[tx.transaction_type] || 0) + tx.amount;
        return acc;
      }, {});

      const labels = Object.keys(totals);
      const values = Object.values(totals);

      // ðŸ›  Prevent error: check if chart exists and has destroy()
      if (window.categoryChart && typeof window.categoryChart.destroy === "function") {
        window.categoryChart.destroy();
      }

      window.categoryChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            label: "Expenses by Type",
            data: values,
            backgroundColor: [
              ...labels.map((_, i, arr) => {
                const hue = (i * 360 / arr.length) % 360;
                return `hsl(${hue}, 70%, 60%)`;
              })
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,  // allows flexible scaling
          devicePixelRatio: 2,
          plugins: {
            tooltip: {
              enabled: true,
              mode: "nearest",
              intersect: false,
              callbacks: {
                label: ctx => {
                  const value = ctx.raw;
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                  const percent = ((value / total) * 100).toFixed(1);
                  return `â‚¹${value.toLocaleString()} (${percent}%)`;
                }
              },
              legend: { display: false },
              title: { display: true, text: "Spending by Category" }
            },
            interaction: {
              mode: "index",
              intersect: false
            }
          }
        }
      });
    }

    // Render daily spending trend (Line)
    function renderDailyChart(transactions) {
      const dailyTotals = {};
      charts = document.getElementById("charts");
      charts.style.display = "flex";

      transactions.forEach(tx => {
        if (tx.transaction_type === "Debit") {
          const d = new Date(tx.date);
          const day = d.toISOString().slice(0, 10); // YYYY-MM-DD
          const amt = parseFloat(tx.amount) || 0;
          dailyTotals[day] = (dailyTotals[day] || 0) + amt;
        }
      });

      const labels = Object.keys(dailyTotals).sort();
      const values = labels.map(l => dailyTotals[l]);

      const ctx = document.getElementById("dailyChart").getContext("2d");
      if (window.dailyChart && typeof window.dailyChart.destroy === "function") {
        window.dailyChart.destroy();
      }

      console.log("Daily Chart Data:", { labels, values });

      window.dailyChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Daily Spending",
            data: values,
            fill: false,
            borderColor: "blue",
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,  // allows flexible scaling
          devicePixelRatio: 2,
          plugins: {
            tooltip: {
              enabled: true,
              mode: "nearest",
              intersect: false,
              callbacks: {
                label: ctx => `â‚¹${ctx.raw.toLocaleString()}`
              },
              legend: { display: false },
              title: { display: true, text: "Daily Spending Trend" }
            },
            interaction: {
              mode: "index",
              intersect: false
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        }
      });
    }
    function renderSubcategoryChart(transactions) {
      const grouped = {};
      console.log("Rendering Subcategory Chart with transactions:", transactions);
      transactions.forEach(t => {
        if (t.transaction_type === "Debit") {
          grouped[t.subcategory] = (grouped[t.subcategory] || 0) + t.amount;
        }
      });

      const ctx = document.getElementById("subcategoryChart").getContext("2d");
      const ctx2 = document.getElementById("subcategoryPieChart").getContext("2d");
      if (window.subcategoryChart && typeof window.subcategoryChart.destroy === "function") {
        window.subcategoryChart.destroy();
      }

      console.log("Subcategory Chart Data:", grouped);
      window.subcategoryChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: Object.keys(grouped),
          datasets: [{
            label: "Spending by Subcategory",
            data: Object.values(grouped),
            backgroundColor: [
              ...Object.keys(grouped).map((_, i) => {
                // Generate visually distinct colors using HSL
                const hue = (i * 360 / Object.keys(grouped).length) % 360;
                return `hsl(${hue}, 70%, 60%)`;
              })
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,  // allows flexible scaling
          devicePixelRatio: 2,
          plugins: {
            tooltip: {
              enabled: true,
              mode: "nearest",
              intersect: false,
              callbacks: {
                label: ctx => `â‚¹${ctx.raw.toLocaleString()}`
              },
              title: { display: true, text: "Subcategory Breakdown" }
            },
            legend: {
              display: true,
              position: "top",
              labels: {
                generateLabels: function (chart) {
                  // Show all subcategories with their values in legend
                  const data = chart.data;
                  return data.labels.map((label, i) => ({
                    text: `${label}: â‚¹${data.datasets[0].data[i].toLocaleString()}`,
                    fillStyle: data.datasets[0].backgroundColor[i % data.datasets[0].backgroundColor.length],
                    strokeStyle: data.datasets[0].backgroundColor[i % data.datasets[0].backgroundColor.length],
                    index: i
                  }));
                }
              }
            }
          },
          interaction: {
            mode: "index",
            intersect: false
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      }
      );
      window.categoryChart = new Chart(ctx2, {
        type: "pie",
        data: {
          labels: Object.keys(grouped),
          datasets: [{
            label: "Spending by Subcategory",
            data: Object.values(grouped),
            backgroundColor: [
              ...Object.keys(grouped).map((_, i) => {
                // Generate visually distinct colors using HSL
                const hue = (i * 360 / Object.keys(grouped).length) % 360;
                return `hsl(${hue}, 70%, 60%)`;
              })
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,  // allows flexible scaling
          devicePixelRatio: 2,
          plugins: {
            tooltip: {
              enabled: true,
              mode: "nearest",
              intersect: false,
              callbacks: {
                label: ctx => {
                  const value = ctx.raw;
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                  const percent = ((value / total) * 100).toFixed(1);
                  return `â‚¹${value.toLocaleString()} (${percent}%)`;
                }
              },
              title: { display: true, text: "Subcategory Breakdown" }
            },
            legend: {
              display: true,
              position: "top",
              labels: {
                generateLabels: function (chart) {
                  // Show all subcategories with their values in legend
                  const data = chart.data;
                  return data.labels.map((label, i) => ({
                    text: `${label}: â‚¹${data.datasets[0].data[i].toLocaleString()}`,
                    fillStyle: data.datasets[0].backgroundColor[i % data.datasets[0].backgroundColor.length],
                    strokeStyle: data.datasets[0].backgroundColor[i % data.datasets[0].backgroundColor.length],
                    index: i
                  }));
                }
              }
            }
          },
          interaction: {
            mode: "index",
            intersect: false
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }


  </script>

</body>

</html>